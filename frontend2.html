<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AskTube â€” Chat with any YouTube video</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0b;
    --surface: #111114;
    --surface2: #18181d;
    --border: rgba(255,255,255,0.07);
    --border-active: rgba(255,180,0,0.4);
    --amber: #f5a623;
    --amber-dim: rgba(245,166,35,0.12);
    --amber-glow: rgba(245,166,35,0.06);
    --text: #e8e6e0;
    --text-muted: #6b6a66;
    --text-dim: #9b9890;
    --red: #e05454;
    --green: #4caf7d;
    --radius: 6px;
    --radius-lg: 12px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    overflow: hidden;
  }

  /* Subtle noise texture */
  body::before {
    content: '';
    position: fixed; inset: 0; z-index: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    opacity: 0.4;
  }

  /* Ambient top glow */
  body::after {
    content: '';
    position: fixed; top: -200px; left: 50%; transform: translateX(-50%);
    width: 800px; height: 400px;
    background: radial-gradient(ellipse, rgba(245,166,35,0.06) 0%, transparent 70%);
    pointer-events: none; z-index: 0;
  }

  .app {
    position: relative; z-index: 1;
    display: grid;
    grid-template-rows: auto 1fr;
    height: 100vh;
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 0 16px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    display: flex; align-items: baseline; gap: 2px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 2px;
    line-height: 1;
  }
  .logo-ask { color: var(--text-muted); }
  .logo-tube { color: var(--amber); }

  .header-meta {
    display: flex; align-items: center; gap: 20px;
  }

  .status-pill {
    display: flex; align-items: center; gap: 7px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text-muted);
    transition: background 0.4s, box-shadow 0.4s;
  }
  .status-dot.ready { background: var(--green); box-shadow: 0 0 8px var(--green); }
  .status-dot.processing {
    background: var(--amber);
    animation: pulse-dot 1.2s ease-in-out infinite;
  }
  .status-dot.error { background: var(--red); }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; box-shadow: 0 0 4px var(--amber); }
    50% { opacity: 0.4; box-shadow: 0 0 12px var(--amber); }
  }

  /* â”€â”€ MAIN LAYOUT â”€â”€ */
  .main {
    display: grid;
    grid-template-columns: 1fr 420px;
    gap: 20px;
    padding: 20px 0;
    overflow: hidden;
    min-height: 0;
  }

  /* â”€â”€ LEFT PANEL â”€â”€ */
  .left-panel {
    display: flex; flex-direction: column; gap: 16px;
    overflow: hidden; min-height: 0;
  }

  /* URL Input Area */
  .url-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 20px;
    transition: border-color 0.3s;
  }
  .url-section:focus-within { border-color: var(--border-active); }

  .section-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 12px;
  }

  .url-input-row {
    display: flex; gap: 10px;
  }

  .url-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 14px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s, background 0.2s;
  }
  .url-input::placeholder { color: var(--text-muted); }
  .url-input:focus {
    border-color: var(--amber);
    background: rgba(245,166,35,0.04);
  }

  .btn-submit {
    background: var(--amber);
    color: #0a0a0b;
    border: none; border-radius: var(--radius);
    padding: 10px 22px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: opacity 0.2s, transform 0.1s;
    position: relative; overflow: hidden;
  }
  .btn-submit:hover { opacity: 0.9; }
  .btn-submit:active { transform: scale(0.97); }
  .btn-submit:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .btn-submit .btn-text { transition: opacity 0.2s; }
  .btn-submit.loading .btn-text { opacity: 0; }
  .btn-submit .spinner {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.2s;
  }
  .btn-submit.loading .spinner { opacity: 1; }
  .spinner-ring {
    width: 16px; height: 16px;
    border: 2px solid rgba(0,0,0,0.3);
    border-top-color: #0a0a0b;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Progress bar */
  .progress-bar-wrap {
    margin-top: 12px;
    height: 2px;
    background: var(--surface2);
    border-radius: 2px;
    overflow: hidden;
    opacity: 0;
    transition: opacity 0.3s;
  }
  .progress-bar-wrap.visible { opacity: 1; }
  .progress-bar {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, var(--amber), #ffdc6e);
    border-radius: 2px;
    transition: width 0.4s ease;
  }
  .progress-bar.indeterminate {
    width: 40%;
    animation: slide-progress 1.5s ease-in-out infinite;
  }
  @keyframes slide-progress {
    0% { transform: translateX(-150%); }
    100% { transform: translateX(350%); }
  }

  /* Video Player */
  .video-section {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    display: flex; flex-direction: column;
    min-height: 0;
    position: relative;
  }

  .video-placeholder {
    flex: 1;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 14px;
    color: var(--text-muted);
    padding: 40px;
    text-align: center;
  }

  .video-placeholder-icon {
    width: 56px; height: 56px;
    border: 2px solid var(--border);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .video-placeholder-icon::before {
    content: '';
    width: 0; height: 0;
    border-style: solid;
    border-width: 10px 0 10px 18px;
    border-color: transparent transparent transparent var(--border);
    margin-left: 4px;
  }

  .video-placeholder p {
    font-size: 13px;
    line-height: 1.6;
    max-width: 260px;
  }
  .video-placeholder span {
    display: block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-muted);
    opacity: 0.5;
  }

  .video-container {
    flex: 1;
    display: none;
    flex-direction: column;
    min-height: 0;
  }
  .video-container.active { display: flex; }

  video {
    width: 100%; flex: 1;
    object-fit: contain;
    background: #000;
    min-height: 0;
  }

  .video-info-bar {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px;
  }

  .video-info-bar .job-id {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.5px;
  }

  .tag {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 3px;
    border: 1px solid;
  }
  .tag-processing { border-color: rgba(245,166,35,0.3); color: var(--amber); background: var(--amber-dim); }
  .tag-ready { border-color: rgba(76,175,125,0.3); color: var(--green); background: rgba(76,175,125,0.1); }

  .btn-transcribe {
    margin-left: auto;
    background: transparent;
    border: 1px solid var(--amber);
    color: var(--amber);
    border-radius: var(--radius);
    padding: 6px 14px;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
  }
  .btn-transcribe:hover { background: var(--amber-dim); }
  .btn-transcribe:disabled { opacity: 0.35; cursor: not-allowed; }

  /* â”€â”€ RIGHT PANEL â€” CHAT â”€â”€ */
  .chat-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    display: flex; flex-direction: column;
    overflow: hidden; min-height: 0;
    position: relative;
  }

  .chat-header {
    padding: 16px 20px 14px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
  }

  .chat-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 1.5px;
    color: var(--text);
  }

  .chat-locked-overlay {
    position: absolute; inset: 0; z-index: 10;
    background: rgba(10,10,11,0.85);
    backdrop-filter: blur(4px);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 12px;
    transition: opacity 0.4s;
  }
  .chat-locked-overlay.hidden { opacity: 0; pointer-events: none; }

  .lock-icon {
    width: 40px; height: 40px;
    border: 1.5px solid var(--border);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
  }

  .chat-locked-overlay p {
    font-size: 13px;
    color: var(--text-muted);
    text-align: center;
    max-width: 220px;
    line-height: 1.6;
  }

  /* Messages */
  .messages {
    flex: 1; overflow-y: auto;
    padding: 20px;
    display: flex; flex-direction: column; gap: 16px;
    scroll-behavior: smooth;
    min-height: 0;
  }
  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--surface2); border-radius: 2px; }

  .message {
    display: flex; flex-direction: column; gap: 4px;
    animation: msg-in 0.25s ease both;
  }
  @keyframes msg-in {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message.user { align-items: flex-end; }
  .message.assistant { align-items: flex-start; }

  .msg-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-muted);
    padding: 0 4px;
  }

  .msg-bubble {
    max-width: 88%;
    padding: 10px 14px;
    border-radius: var(--radius);
    line-height: 1.65;
    font-size: 14px;
  }

  .message.user .msg-bubble {
    background: var(--amber-dim);
    border: 1px solid rgba(245,166,35,0.2);
    color: var(--text);
    border-bottom-right-radius: 2px;
  }

  .message.assistant .msg-bubble {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    border-bottom-left-radius: 2px;
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex; align-items: center; gap: 5px;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    border-bottom-left-radius: 2px;
    width: fit-content;
  }
  .typing-dot {
    width: 5px; height: 5px;
    background: var(--text-muted);
    border-radius: 50%;
    animation: typing 1.2s ease-in-out infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-4px); opacity: 1; }
  }

  .chat-empty {
    flex: 1; display: flex;
    flex-direction: column; align-items: center; justify-content: center;
    gap: 8px; text-align: center; color: var(--text-muted);
    padding: 20px;
  }
  .chat-empty-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 1px;
    color: var(--text-dim);
  }
  .chat-empty p {
    font-size: 13px; line-height: 1.6;
    max-width: 240px;
  }

  .suggestions {
    display: flex; flex-direction: column; gap: 8px;
    margin-top: 16px; width: 100%;
  }
  .suggestion-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 9px 14px;
    color: var(--text-dim);
    font-size: 13px;
    text-align: left;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s, color 0.2s;
    font-family: 'DM Sans', sans-serif;
  }
  .suggestion-btn:hover {
    border-color: var(--border-active);
    background: var(--amber-glow);
    color: var(--text);
  }

  /* Chat input */
  .chat-input-area {
    padding: 16px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }

  .chat-input-row {
    display: flex; gap: 10px; align-items: flex-end;
  }

  .chat-textarea {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 14px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
    resize: none;
    line-height: 1.5;
    max-height: 120px;
    overflow-y: auto;
    transition: border-color 0.2s;
  }
  .chat-textarea::placeholder { color: var(--text-muted); }
  .chat-textarea:focus { border-color: var(--border-active); }
  .chat-textarea::-webkit-scrollbar { width: 3px; }
  .chat-textarea::-webkit-scrollbar-thumb { background: var(--border); }

  .btn-send {
    background: var(--amber);
    color: #0a0a0b;
    border: none; border-radius: var(--radius);
    width: 38px; height: 38px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-send:hover { opacity: 0.85; }
  .btn-send:active { transform: scale(0.93); }
  .btn-send:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
  .btn-send svg { width: 16px; height: 16px; }

  .input-hint {
    margin-top: 8px;
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.3px;
  }

  /* Toast */
  .toast {
    position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 18px;
    font-size: 13px; color: var(--text);
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .toast.error { border-color: rgba(224,84,84,0.4); color: var(--red); }
  .toast.success { border-color: rgba(76,175,125,0.4); color: var(--green); }

</style>
</head>
<body>

<div class="app">
  <header>
    <div class="logo">
      <span class="logo-ask">Ask</span>
      <span class="logo-tube">Tube</span>
    </div>
    <div class="header-meta">
      <div class="status-pill">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Idle</span>
      </div>
    </div>
  </header>

  <div class="main">
    <!-- LEFT PANEL -->
    <div class="left-panel">
      <!-- URL Input -->
      <div class="url-section">
        <div class="section-label">YouTube URL</div>
        <div class="url-input-row">
          <input
            class="url-input"
            id="urlInput"
            type="text"
            placeholder="https://www.youtube.com/watch?v=..."
            autocomplete="off"
            spellcheck="false"
          >
          <button class="btn-submit" id="submitBtn" onclick="submitURL()">
            <span class="btn-text">Load Video</span>
            <span class="spinner"><span class="spinner-ring"></span></span>
          </button>
        </div>
        <div class="progress-bar-wrap" id="progressWrap">
          <div class="progress-bar indeterminate" id="progressBar"></div>
        </div>
      </div>

      <!-- Video Player -->
      <div class="video-section">
        <div class="video-placeholder" id="videoPlaceholder">
          <div class="video-placeholder-icon"></div>
          <p>Paste a YouTube URL above and click <strong style="color:var(--amber)">Load Video</strong> to get started</p>
          <span>Supports any public YouTube video</span>
        </div>
        <div class="video-container" id="videoContainer">
          <video id="videoPlayer" controls></video>
          <div class="video-info-bar">
            <span class="job-id" id="jobIdDisplay"></span>
            <span class="tag tag-processing" id="videoStatusTag">Processing</span>
            <button class="btn-transcribe" id="transcribeBtn" onclick="startTranscription()" disabled>
              Transcribe &amp; Index
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL â€” CHAT -->
    <div class="chat-panel">
      <div class="chat-header">
        <span class="chat-title">Ask the Video</span>
        <div class="status-pill">
          <div class="status-dot" id="wsStatusDot"></div>
          <span id="wsStatusText">Disconnected</span>
        </div>
      </div>

      <div class="chat-locked-overlay" id="chatLock">
        <div class="lock-icon">ðŸ”’</div>
        <p>Transcribe and index the video first to unlock the chat</p>
      </div>

      <div class="messages" id="messages">
        <div class="chat-empty" id="chatEmpty">
          <div class="chat-empty-title">Ask anything</div>
          <p>Once indexed, you can ask questions about anything in the video</p>
          <div class="suggestions">
            <button class="suggestion-btn" onclick="sendSuggestion(this)">What is the main topic discussed?</button>
            <button class="suggestion-btn" onclick="sendSuggestion(this)">Summarize the key points</button>
            <button class="suggestion-btn" onclick="sendSuggestion(this)">What happens at the beginning?</button>
          </div>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="chat-input-row">
          <textarea
            class="chat-textarea"
            id="chatInput"
            placeholder="Ask something about the video..."
            rows="1"
            disabled
            onkeydown="handleChatKey(event)"
            oninput="autoResize(this)"
          ></textarea>
          <button class="btn-send" id="sendBtn" onclick="sendMessage()" disabled>
            <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 10l14-7-5 14-3-6-6-1z"/>
            </svg>
          </button>
        </div>
        <div class="input-hint">â†µ Enter to send &nbsp;Â·&nbsp; Shift+â†µ new line</div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // â”€â”€ State â”€â”€
  let currentJobId = null;
  let websocket = null;
  let isConnected = false;
  let isWaitingForResponse = false;

  // â”€â”€ DOM Refs â”€â”€
  const urlInput = document.getElementById('urlInput');
  const submitBtn = document.getElementById('submitBtn');
  const progressWrap = document.getElementById('progressWrap');
  const progressBar = document.getElementById('progressBar');
  const videoPlaceholder = document.getElementById('videoPlaceholder');
  const videoContainer = document.getElementById('videoContainer');
  const videoPlayer = document.getElementById('videoPlayer');
  const jobIdDisplay = document.getElementById('jobIdDisplay');
  const videoStatusTag = document.getElementById('videoStatusTag');
  const transcribeBtn = document.getElementById('transcribeBtn');
  const chatLock = document.getElementById('chatLock');
  const messages = document.getElementById('messages');
  const chatEmpty = document.getElementById('chatEmpty');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const wsStatusDot = document.getElementById('wsStatusDot');
  const wsStatusText = document.getElementById('wsStatusText');

  // â”€â”€ Utilities â”€â”€
  function showToast(msg, type = '') {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = `toast show ${type}`;
    setTimeout(() => toast.className = 'toast', 3200);
  }

  function setStatus(dot, text, state) {
    dot.className = `status-dot ${state}`;
    text.textContent = state === 'ready' ? 'Ready' : state === 'processing' ? 'Processing' : state === 'error' ? 'Error' : text.textContent;
    text.textContent = { idle: 'Idle', ready: 'Ready', processing: 'Processing...', error: 'Error' }[state] || text.textContent;
  }

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  function scrollToBottom() {
    messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
  }

  // â”€â”€ Step 1: Submit URL â”€â”€
  async function submitURL() {
    const url = urlInput.value.trim();
    if (!url) { showToast('Please enter a YouTube URL', 'error'); return; }

    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    progressWrap.classList.add('visible');
    setStatus(statusDot, statusText, 'processing');
    statusText.textContent = 'Downloading...';

    try {
      const res = await fetch(`/upload-url?url=${encodeURIComponent(url)}`, { method: 'POST' });
      if (!res.ok) throw new Error('Upload failed');
      const data = await res.json();
      currentJobId = data.job_id;

      jobIdDisplay.textContent = `JOB Â· ${currentJobId.slice(0, 8).toUpperCase()}`;
      videoPlaceholder.style.display = 'none';
      videoContainer.classList.add('active');
      videoPlayer.src = `/videos/${currentJobId}/video.mp4`;

      showToast('Video downloaded. Processing audio...', '');
      pollStatus(currentJobId);
    } catch (e) {
      showToast('Failed to load video', 'error');
      setStatus(statusDot, statusText, 'error');
      progressWrap.classList.remove('visible');
      submitBtn.classList.remove('loading');
      submitBtn.disabled = false;
    }
  }

  // â”€â”€ Step 2: Poll Status â”€â”€
  function pollStatus(jobId) {
    let attempts = 0;
    const interval = setInterval(async () => {
      try {
        attempts++;
        const res = await fetch(`/status/${jobId}`);
        const data = await res.json();

        if (data.status === 'ready') {
          clearInterval(interval);
          progressBar.classList.remove('indeterminate');
          progressBar.style.width = '100%';
          videoStatusTag.textContent = 'Ready';
          videoStatusTag.className = 'tag tag-ready';
          transcribeBtn.disabled = false;
          setStatus(statusDot, statusText, 'ready');
          statusText.textContent = 'Audio Ready';
          showToast('Processing complete! Click "Transcribe & Index" to enable chat.', 'success');

          setTimeout(() => {
            progressWrap.classList.remove('visible');
            progressBar.style.width = '0%';
          }, 1500);
        } else if (data.status === 'failed' || attempts > 120) {
          clearInterval(interval);
          setStatus(statusDot, statusText, 'error');
          showToast('Processing failed', 'error');
        }
      } catch (e) { /* retry */ }

      submitBtn.classList.remove('loading');
      submitBtn.disabled = false;
    }, 3000);
  }

  // â”€â”€ Step 3: Transcribe â”€â”€
  async function startTranscription() {
    if (!currentJobId) return;
    transcribeBtn.disabled = true;
    transcribeBtn.textContent = 'Indexing...';
    setStatus(statusDot, statusText, 'processing');
    statusText.textContent = 'Transcribing...';

    try {
      const res = await fetch(`/upload/${currentJobId}`, { method: 'POST' });
      if (!res.ok) throw new Error('Transcription failed');
      showToast('Transcription complete! Chat is now unlocked.', 'success');
      transcribeBtn.textContent = 'Indexed âœ“';
      setStatus(statusDot, statusText, 'ready');
      statusText.textContent = 'Indexed';
      unlockChat();
    } catch (e) {
      showToast('Transcription failed', 'error');
      transcribeBtn.disabled = false;
      transcribeBtn.textContent = 'Transcribe & Index';
      setStatus(statusDot, statusText, 'error');
    }
  }

  // â”€â”€ Step 4: Unlock Chat & WebSocket â”€â”€
  function unlockChat() {
    chatLock.classList.add('hidden');
    chatInput.disabled = false;
    sendBtn.disabled = false;
    connectWebSocket();
  }

  function connectWebSocket() {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    websocket = new WebSocket(`${proto}://${location.host}/upload/${currentJobId}/query`);

    websocket.onopen = () => {
      isConnected = true;
      wsStatusDot.className = 'status-dot ready';
      wsStatusText.textContent = 'Connected';
      showToast('Chat connected', 'success');
    };

    websocket.onmessage = (e) => {
      removeTypingIndicator();
      appendMessage('assistant', e.data);
      isWaitingForResponse = false;
      sendBtn.disabled = false;
    };

    websocket.onclose = () => {
      isConnected = false;
      wsStatusDot.className = 'status-dot error';
      wsStatusText.textContent = 'Disconnected';
    };

    websocket.onerror = () => {
      showToast('WebSocket error', 'error');
    };
  }

  // â”€â”€ Chat â”€â”€
  function appendMessage(role, text) {
    if (chatEmpty) {
      const empty = document.getElementById('chatEmpty');
      if (empty) empty.style.display = 'none';
    }

    const msg = document.createElement('div');
    msg.className = `message ${role}`;
    msg.innerHTML = `
      <span class="msg-label">${role === 'user' ? 'You' : 'AI'}</span>
      <div class="msg-bubble">${escapeHtml(text)}</div>
    `;
    messages.appendChild(msg);
    scrollToBottom();
  }

  function showTypingIndicator() {
    const existing = document.getElementById('typingIndicator');
    if (existing) return;
    const wrap = document.createElement('div');
    wrap.className = 'message assistant';
    wrap.id = 'typingIndicator';
    wrap.innerHTML = `
      <span class="msg-label">AI</span>
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
    messages.appendChild(wrap);
    scrollToBottom();
  }

  function removeTypingIndicator() {
    const el = document.getElementById('typingIndicator');
    if (el) el.remove();
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  }

  function sendMessage() {
    const text = chatInput.value.trim();
    if (!text || !isConnected || isWaitingForResponse) return;
    appendMessage('user', text);
    chatInput.value = '';
    chatInput.style.height = 'auto';
    websocket.send(text);
    isWaitingForResponse = true;
    sendBtn.disabled = true;
    showTypingIndicator();
  }

  function sendSuggestion(btn) {
    chatInput.value = btn.textContent;
    sendMessage();
  }

  function handleChatKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  urlInput.addEventListener('keydown', e => { if (e.key === 'Enter') submitURL(); });
</script>
</body>
</html>
